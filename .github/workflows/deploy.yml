name: Deploy to Portainer

on:
  push:
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - development
          - production
          - both
      git_branch:
        description: 'Git branch to deploy from (leave empty to use default)'
        required: false
        type: string

permissions:
  id-token: write
  contents: read

jobs:
  determine-environment:
    runs-on: ubuntu-latest
    outputs:
      deploy_dev: ${{ steps.set-env.outputs.deploy_dev }}
      deploy_prod: ${{ steps.set-env.outputs.deploy_prod }}
    steps:
      - name: Determine deployment environment(s)
        id: set-env
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
              echo 'deploy_dev=false' >> $GITHUB_OUTPUT
              echo 'deploy_prod=true' >> $GITHUB_OUTPUT
            elif [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
              echo 'deploy_dev=true' >> $GITHUB_OUTPUT
              echo 'deploy_prod=false' >> $GITHUB_OUTPUT
            fi
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            case "${{ github.event.inputs.environment }}" in
              "development")
                echo 'deploy_dev=true' >> $GITHUB_OUTPUT
                echo 'deploy_prod=false' >> $GITHUB_OUTPUT
                ;;
              "production")
                echo 'deploy_dev=false' >> $GITHUB_OUTPUT
                echo 'deploy_prod=true' >> $GITHUB_OUTPUT
                ;;
              "both")
                echo 'deploy_dev=true' >> $GITHUB_OUTPUT
                echo 'deploy_prod=true' >> $GITHUB_OUTPUT
                ;;
            esac
          fi

  deploy-development:
    needs: determine-environment
    if: needs.determine-environment.outputs.deploy_dev == 'true'
    uses: ./.github/workflows/_reusable-deploy-terraform-stack.yml
    with:
      environment: development
      stack_name: lab-authentik-development
      git_branch: ${{ github.event.inputs.git_branch || 'develop' }}
      compose_file_path: 'docker/docker-compose.yml'
      tf_state_key: 'lab-authentik/development.tfstate'
      docker_host_ip: ${{ vars.DOCKER_HOST_IP }}
      ssh_user: 'deploy'
    secrets:
      netbird_setup_key: ${{ secrets.NETBIRD_SETUP_KEY }}
      portainer_token: ${{ secrets.PORTAINER_TOKEN }}
      gh_pat: ${{ secrets.GH_PAT }}
      cloudflare_tunnel_token: ${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}
      db_password: ${{ secrets.DB_PASSWORD }}
      ssh_private_key: ${{ secrets.SSH_PRIVATE_KEY }}
      authentik_secret_key: ${{ secrets.AUTHENTIK_SECRET_KEY }}
      authentik_bootstrap_password: ${{ secrets.AUTHENTIK_BOOTSTRAP_PASSWORD }}

  deploy-production:
    needs: [determine-environment, deploy-development]
    if: |
      always() &&
      needs.determine-environment.outputs.deploy_prod == 'true' &&
      (needs.deploy-development.result == 'success' || needs.deploy-development.result == 'skipped')
    uses: ./.github/workflows/_reusable-deploy-terraform-stack.yml
    with:
      environment: production
      stack_name: lab-authentik-production
      git_branch: ${{ github.event.inputs.git_branch || 'main' }}
      compose_file_path: 'docker/docker-compose.yml'
      tf_state_key: 'lab-authentik/production.tfstate'
      docker_host_ip: ${{ vars.DOCKER_HOST_IP }}
      ssh_user: 'deploy'
    secrets:
      netbird_setup_key: ${{ secrets.NETBIRD_SETUP_KEY }}
      portainer_token: ${{ secrets.PORTAINER_TOKEN }}
      gh_pat: ${{ secrets.GH_PAT }}
      cloudflare_tunnel_token: ${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}
      db_password: ${{ secrets.DB_PASSWORD }}
      ssh_private_key: ${{ secrets.SSH_PRIVATE_KEY }}
      authentik_secret_key: ${{ secrets.AUTHENTIK_SECRET_KEY }}
      authentik_bootstrap_password: ${{ secrets.AUTHENTIK_BOOTSTRAP_PASSWORD }}
